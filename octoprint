#!/usr/bin/env bash

APIKEY=$(cat ~/.octoprint/apikey)
URL=$(cat ~/.octoprint/url)

USAGE=$(cat <<EOF
$(basename $0) [ -v | --verbose ] [ --timelapse ] [ --fps FPS ] [ --interval INTERVAL ] [ --post-roll POSTROLL ] FILE
EOF
)

FPS=10
INTERVAL=10
POST_ROLL=5
while [[ "$1" != "" ]]; do
   case "$1" in
       "--help" | "-h")
         echo "$USAGE"
         exit 0
         ;;
       "--timelapse")
         TIMELAPSE=yes
         ;;
       "--interval")
         shift
         TIMELAPSE=yes
         INTERVAL=$1
         ;;
       "--fps" )
         shift
         TIMELAPSE=yes
         FPS=$1
         ;;
       "--post-roll" )
         shift
         TIMELAPSE=yes
         POST_ROLL=$1
         ;;
       "-v" | "--verbose")
         VERBOSE=yes
         set -x
         ;;
       *)
         if [[ $1 =~ ^- ]]
         then
             echo "Unrecognized option $1"
             echo $USAGE
             exit 1
         fi

         INPUTFILE=$1
         ;;
   esac
   shift
done

CURL_OPTIONS=$(if [[ -n $VERBOSE ]]; then echo "-i"; fi)

if [[ -z $INPUTFILE ]]
then
    echo "You must specify a file to send."
    exit 1
fi

if [[ ! -z $TIMELAPSE ]]
then
    echo "Enabling timelapse"
    curl $CURL_OPTIONS \
         -X POST \
         -H "X-Api-Key: ${APIKEY}" \
         -H "Content-Type: application/json" \
         $URL/api/timelapse \
         -d @- \
         <<EOF
{
  "type" : "timed",
  "postRoll" : $POST_ROLL,
  "fps" : $FPS,
  "interval" : $INTERVAL
}
EOF
fi

TIMESTAMP=$(date +'%Y%m%d-%H%M%S')
FILENAME=$(basename $INPUTFILE .gcode)-$TIMESTAMP.gcode

echo "Uploading $INPUTFILE to $URL as $FILENAME"

curl $CURL_OPTIONS -H "X-Api-Key:${APIKEY}" -F "file=@${INPUTFILE};filename=${FILENAME}" $URL/api/files/local

echo "Printing $FILENAME"

curl $CURL_OPTIONS \
     -X POST \
     -H "X-Api-Key: ${APIKEY}" \
     -H "Content-Type: application/json" \
     $URL/api/files/local/${FILENAME} \
     -d @- \
     <<EOF
{
  "command" : "select",
  "print" : true
}
EOF
